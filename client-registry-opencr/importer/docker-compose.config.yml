version: '3.9'

services:
  hapi_partition_config:
    image: node:erbium-alpine
    command: sh -c "cd /importer && ls && npm i && ls && node create-partition.js"
    configs:
      - target: /importer/package.json
        source: package.json
      - target: /importer/create-partition.js
        source: create-partition.js
    networks:
      - opencr
      - hapi-fhir
    environment:
      PARTITION_NAME: ${HF_PARTITION_NAME}
    deploy:
      replicas: 1
      restart_policy:
        condition: none

networks:
  hapi-fhir:
    name: hapi-fhir_public
    external: true

configs:
  package.json:
    file: ./package.json
    name: package.json-${package_json_DIGEST:?err}
    labels:
      name: opencr
  create-partition.js:
    file: ./create-partition.js
    name: create_partition.js-${create_partition_js_DIGEST:?err}
    labels:
      name: opencr
